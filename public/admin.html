<script>
  // Définir l'URL complète de votre backend sur Render
  const API_URL = "https://eventsnexus.onrender.com";
  
  // Fonction pour lire les paramètres de l'URL
  function getQueryParams() {
      const params = {};
      window.location.search.substr(1).split("&").forEach(function(item) {
          const [key, value] = item.split("=");
          if (key) {
              params[key] = decodeURIComponent(value);
          }
      });
      return params;
  }
  
  document.addEventListener("DOMContentLoaded", () => {
      // Récupération des informations de l'admin depuis l'URL
      const params = getQueryParams();
      const headerInfo = document.getElementById("adminHeaderInfo");
      const adminUsername = params.username || ""; // Doit être passé lors de la redirection depuis login
      if (params.fullName && params.role) {
          headerInfo.innerText = `${params.fullName} - ${params.role}`;
      } else {
          headerInfo.innerText = "Administrateur";
      }
      
      // Variables pour gérer la suppression via le modal
      let submissionToDeleteId = null;
      const confirmationModal = document.getElementById("confirmationModal");
      const cancelDeleteBtn = document.getElementById("cancelDelete");
      const confirmDeleteBtn = document.getElementById("confirmDelete");
      
      // Annuler la suppression : masquer le modal
      cancelDeleteBtn.addEventListener("click", () => {
          confirmationModal.classList.add("hidden");
          submissionToDeleteId = null;
      });
      
      // Confirmer la suppression : envoyer la requête DELETE
      confirmDeleteBtn.addEventListener("click", () => {
          if (submissionToDeleteId) {
            fetch(`${API_URL}/submission/${submissionToDeleteId}?adminUsername=${encodeURIComponent(adminUsername)}`, {
              method: "DELETE", 
              headers: { "Content-Type": "application/json" }
            })

              .then(response => {
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
              })
              .then(result => {
                  const actionMessage = document.getElementById("actionMessage");
                  actionMessage.innerText = result.message;
                  actionMessage.className = "text-red-500 font-bold text-center mb-4";
                  confirmationModal.classList.add("hidden");
                  setTimeout(() => location.reload(), 1500);
              })
              .catch(err => {
                  console.error(err);
                  const actionMessage = document.getElementById("actionMessage");
                  actionMessage.innerText = "Erreur lors de la suppression.";
                  actionMessage.className = "text-red-500 font-bold text-center mb-4";
                  confirmationModal.classList.add("hidden");
              });
          }
      });
      
      // Récupérer la liste des inscriptions depuis le serveur en utilisant l'URL complète
      fetch(`${API_URL}/submissions`)
          .then(response => {
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
          })
          .then(data => {
              const submissionsList = document.getElementById("submissionsList");
              submissionsList.innerHTML = "";
              if (data.length === 0) {
                  submissionsList.innerHTML = '<p class="text-center text-gray-400">Aucune inscription pour le moment.</p>';
              } else {
                  data.forEach(item => {
                      // Création de la carte pour chaque inscription
                      const card = document.createElement("div");
                      card.className = "bg-gray-800 p-4 rounded-lg shadow";
                      card.innerHTML = `
                          <h3 class="text-xl font-bold">${item.nomprenom}</h3>
                          <p><strong>Email :</strong> ${item.email}</p>
                          <p><strong>Formation :</strong> ${item.formation}</p>
                          <p><strong>Motivation :</strong> ${item.motivation}</p>
                          <p class="text-sm text-gray-400"><strong>Date :</strong> ${new Date(item.submission_date).toLocaleString()}</p>
                      `;
                      
                      // Zone pour les actions
                      const actionsDiv = document.createElement("div");
                      actionsDiv.className = "mt-2 flex space-x-2";
  
                      // Si l'inscription n'est ni validée ni supprimée, afficher les boutons
                      if (!item.validated && !item.deleted) {
                          // Bouton Valider
                          const validateBtn = document.createElement("button");
                          validateBtn.innerText = "Valider";
                          validateBtn.className = "bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded";
                          validateBtn.addEventListener("click", () => {
                              fetch(`${API_URL}/submission/validate/${item.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ adminUsername })
                              })
                              .then(response => {
                                  if (!response.ok) {
                                      throw new Error(`HTTP error! status: ${response.status}`);
                                  }
                                  return response.json();
                              })
                              .then(result => {
                                  const actionMessage = document.getElementById("actionMessage");
                                  actionMessage.innerText = result.message;
                                  actionMessage.className = "text-green-500 font-bold text-center mb-4";
                                  setTimeout(() => location.reload(), 1500);
                              })
                              .catch(err => {
                                  console.error(err);
                                  const actionMessage = document.getElementById("actionMessage");
                                  actionMessage.innerText = "Erreur lors de la validation.";
                                  actionMessage.className = "text-red-500 font-bold text-center mb-4";
                              });
                          });
                          actionsDiv.appendChild(validateBtn);
  
                          // Bouton Supprimer
                          const deleteBtn = document.createElement("button");
                          deleteBtn.innerText = "Supprimer";
                          deleteBtn.className = "bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded";
                          deleteBtn.addEventListener("click", () => {
                              submissionToDeleteId = item.id;
                              confirmationModal.classList.remove("hidden");
                          });
                          actionsDiv.appendChild(deleteBtn);
                      } else {
                          // Si l'inscription est validée, afficher l'information de validation
                          if (item.validated) {
                              const validatedInfo = document.createElement("p");
                              validatedInfo.className = "text-green-500 text-sm";
                              validatedInfo.innerText = `Validée par ${item.validated_by}`;
                              actionsDiv.appendChild(validatedInfo);
                          }
                          // Si l'inscription est supprimée, afficher l'information de suppression
                          if (item.deleted) {
                              const deletedInfo = document.createElement("p");
                              deletedInfo.className = "text-red-500 text-sm";
                              deletedInfo.innerText = `Supprimée par ${item.deleted_by}`;
                              actionsDiv.appendChild(deletedInfo);
                          }
                      }
  
                      card.appendChild(actionsDiv);
                      submissionsList.appendChild(card);
                  });
              }
          })
          .catch(err => {
              console.error("Erreur lors de la récupération des inscriptions : ", err);
          });
      
      // Countdown Timer vers le 13 février 2025
      const targetDate = new Date("Feb 13, 2025 00:00:00").getTime();
      function updateCountdown() {
          const now = new Date().getTime();
          const gap = targetDate - now;
  
          if (gap < 0) {
              if (document.getElementById("days")) document.getElementById("days").innerText = "00";
              if (document.getElementById("hours")) document.getElementById("hours").innerText = "00";
              if (document.getElementById("minutes")) document.getElementById("minutes").innerText = "00";
              if (document.getElementById("seconds")) document.getElementById("seconds").innerText = "00";
              clearInterval(countdownInterval);
              return;
          }
  
          const days = Math.floor(gap / (1000 * 60 * 60 * 24));
          const hours = Math.floor((gap % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((gap % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((gap % (1000 * 60)) / 1000);
  
          if (document.getElementById("days"))
              document.getElementById("days").innerText = days < 10 ? "0" + days : days;
          if (document.getElementById("hours"))
              document.getElementById("hours").innerText = hours < 10 ? "0" + hours : hours;
          if (document.getElementById("minutes"))
              document.getElementById("minutes").innerText = minutes < 10 ? "0" + minutes : minutes;
          if (document.getElementById("seconds"))
              document.getElementById("seconds").innerText = seconds < 10 ? "0" + seconds : seconds;
      }
  
      updateCountdown();
      const countdownInterval = setInterval(updateCountdown, 1000);
    });
  </script>
  <script src="script.js" defer></script>
</body>
</html>
